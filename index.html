<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hard Platformer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  background: black;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
canvas {
  background: #111;
  border: 2px solid #555;
}
</style>
</head>
<body>

<canvas id="game" width="800" height="400"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const gravity = 0.7;
const jumpCut = 0.4;
const keys = {};

let deaths = 0;
let currentLevel = 0;
const TOTAL_LEVELS = 100;
let spawnGrace = 15;

/* ---------- PLAYER ---------- */
const player = {
  x: 50, y: 300, w: 30, h: 30,
  vx: 0, vy: 0,
  speed: 0.6,
  maxSpeed: 4,
  jump: -14,
  grounded: false,
  wall: false,
  coyote: 0,
  buffer: 0,
  facing: 1
};

/* ---------- LEVEL ARCHETYPES ---------- */
function generateLevel(n) {
  const type = n % 5;
  const platforms = [{ x: 0, y: 360, w: 800, h: 40 }];
  const moving = [];
  const spikes = [{ x: 0, y: 380, w: 800, h: 20 }];
  let goal = { x: 740, y: 300, w: 40, h: 40 };

  const speed = Math.min(1 + n * 0.03, 3);

  /* --- TYPE 0: STAIRCASE --- */
  if (type === 0) {
    let x = 120, y = 300;
    for (let i = 0; i < 6; i++) {
      platforms.push({ x, y, w: 100, h: 20 });
      x += 110;
      y -= 35;
    }
    goal.y = y - 40;
  }

  /* --- TYPE 1: MOVING TIMING --- */
  if (type === 1) {
    for (let i = 0; i < 4; i++) {
      moving.push({
        x: 150 + i * 150,
        y: 260 - i * 30,
        w: 100,
        h: 20,
        dx: speed,
        range: 120,
        startX: 150 + i * 150
      });
    }
    goal.y = 120;
  }

  /* --- TYPE 2: WALL SHAFT --- */
  if (type === 2) {
    for (let i = 0; i < 6; i++) {
      platforms.push({
        x: i % 2 === 0 ? 80 : 620,
        y: 320 - i * 40,
        w: 100,
        h: 20
      });
    }
    goal.x = 380;
    goal.y = 60;
  }

  /* --- TYPE 3: GAP GAUNTLET --- */
  if (type === 3) {
    let x = 120;
    for (let i = 0; i < 5; i++) {
      platforms.push({
        x,
        y: 280,
        w: 80,
        h: 20
      });
      x += 140;
    }
    goal.y = 240;
  }

  /* --- TYPE 4: HYBRID --- */
  if (type === 4) {
    platforms.push({ x: 200, y: 300, w: 120, h: 20 });
    platforms.push({ x: 450, y: 230, w: 120, h: 20 });

    moving.push({
      x: 300,
      y: 160,
      w: 100,
      h: 20,
      dx: speed,
      range: 180,
      startX: 300
    });

    goal.y = 100;
  }

  return { platforms, moving, spikes, goal };
}

let level = generateLevel(0);

/* ---------- INPUT ---------- */
document.addEventListener("keydown", e => keys[e.code] = true);
document.addEventListener("keyup", e => keys[e.code] = false);

/* ---------- UTILS ---------- */
function rect(a, b) {
  return a.x < b.x + b.w && a.x + a.w > b.x &&
         a.y < b.y + b.h && a.y + a.h > b.y;
}

function resetPlayer() {
  player.x = 50;
  player.y = 300;
  player.vx = 0;
  player.vy = 0;
  spawnGrace = 15;
}

function nextLevel() {
  currentLevel++;
  if (currentLevel >= TOTAL_LEVELS) {
    alert("ALL 100 LEVELS CLEARED");
    currentLevel = 0;
    deaths = 0;
  }
  level = generateLevel(currentLevel);
  resetPlayer();
}

/* ---------- UPDATE ---------- */
function update() {
  if (spawnGrace > 0) spawnGrace--;

  if (keys.KeyA) { player.vx -= player.speed; player.facing = -1; }
  if (keys.KeyD) { player.vx += player.speed; player.facing = 1; }

  player.vx *= 0.9;
  player.vx = Math.max(-player.maxSpeed, Math.min(player.maxSpeed, player.vx));

  if (keys.KeyW) player.buffer = 6;
  else player.buffer--;

  player.vy += gravity;

  player.x += player.vx;
  player.y += player.vy;

  player.grounded = false;
  player.wall = false;

  [...level.platforms, ...level.moving].forEach(p => {
    if (rect(player, p)) {
      const px = player.x - player.vx;
      const py = player.y - player.vy;

      if (py + player.h <= p.y) {
        player.y = p.y - player.h;
        player.vy = 0;
        player.grounded = true;
        player.coyote = 6;
        if (p.dx) player.x += p.dx;
      } else if (px + player.w <= p.x) {
        player.x = p.x - player.w;
        player.wall = true;
      } else if (px >= p.x + p.w) {
        player.x = p.x + p.w;
        player.wall = true;
      }
    }
  });

  if (!player.grounded) player.coyote--;

  if (player.buffer > 0) {
    if (player.coyote > 0 || player.wall) {
      player.vy = player.jump;
      if (player.wall) player.vx = -player.facing * 6;
      player.buffer = 0;
    }
  }

  if (!keys.KeyW && player.vy < 0) player.vy *= jumpCut;

  if (spawnGrace <= 0) {
    level.spikes.forEach(s => {
      if (rect(player, s)) {
        deaths++;
        resetPlayer();
      }
    });
  }

  if (rect(player, level.goal)) nextLevel();

  level.moving.forEach(p => {
    p.x += p.dx;
    if (Math.abs(p.x - p.startX) > p.range) p.dx *= -1;
  });
}

/* ---------- DRAW ---------- */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#888";
  level.platforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

  ctx.fillStyle = "#AAA";
  level.moving.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));

  ctx.fillStyle = "red";
  level.spikes.forEach(s => ctx.fillRect(s.x, s.y, s.w, s.h));

  ctx.fillStyle = "gold";
  ctx.fillRect(level.goal.x, level.goal.y, level.goal.w, level.goal.h);

  ctx.fillStyle = "#4CAF50";
  ctx.fillRect(player.x, player.y, 30, 30);

  ctx.fillStyle = "#fff";
  ctx.font = "16px monospace";
  ctx.fillText(`Level ${currentLevel + 1} / ${TOTAL_LEVELS}`, 10, 20);
  ctx.fillText(`Deaths: ${deaths}`, 10, 40);
}

/* ---------- LOOP ---------- */
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
